# Stage 1: build frontend
FROM oven/bun:latest AS frontend-builder
WORKDIR /app

# Install deps (use --frozen-lockfile in production once bun.lockb is committed)
COPY package.json bun.lock* ./
RUN bun install --frozen-lockfile 2>/dev/null || bun install

# Copy rest of source and build
COPY . .
RUN bun run build

# Stage 2: build static server binary
FROM golang:alpine AS server-builder
WORKDIR /app

# Copy server source
COPY server.go ./

# Build static binary (CGO_ENABLED=0 for fully static binary)
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o server server.go

# Stage 3: runtime (scratch - minimal size)
FROM scratch

# Copy compiled server binary
COPY --from=server-builder /app/server /server

# Copy built static files
COPY --from=frontend-builder /app/dist /dist

EXPOSE 8080
ENV PORT=8080
ENV DIST_DIR=/dist
ENTRYPOINT ["/server"]
